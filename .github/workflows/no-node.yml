name: 'CI - No Node Artifacts'

on: [push, pull_request]

jobs:
  check-node-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for node_modules
        run: |
          if [ -d "node_modules" ]; then
              echo "❌ node_modules detected. This repository is GAIS-only. Please remove node_modules.";
              exit 1;
          fi
          if [ -f "package-lock.json" ] || [ -f "pnpm-lock.yaml" ] || [ -f "yarn.lock" ]; then
              echo "❌ Lockfile detected. This repository forbids lockfiles in GAIS edit mode.";
              exit 1;
          fi
          echo "✅ No Node artifacts found."

      - name: Ensure Node APIs only in docs/tools
        run: |
          set -e
          FAIL=0
          for f in $(git ls-files "**/*.*" 2>/dev/null); do
            # skip allowed folder
            if [[ "$f" == docs/tools/* ]]; then
              continue
            fi
            if grep -nE "require\(|from\s+['\"](fs|path|child_process|os|process|Buffer)" "$f" >/dev/null 2>&1; then
              echo "Found Node API usage outside docs/tools: $f"
              grep -nE "require\(|from\s+['\"](fs|path|child_process|os|process|Buffer)" "$f" || true
              FAIL=1
            fi
            # also prevent `.node.` files outside docs/tools
            if [[ "$f" == *".node."* ]] && [[ "$f" != docs/tools/* ]]; then
              echo "Found .node. file outside docs/tools: $f"
              FAIL=1
            fi
          done
          if [ "$FAIL" -eq 1 ]; then
            echo "❌ Node APIs found outside docs/tools. Move Node-only audit tools to docs/tools or remove Node usage.";
            exit 1
          fi
          echo "✅ Node APIs confined to docs/tools or absent."
